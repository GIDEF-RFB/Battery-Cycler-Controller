# This workflow will deploy in development environment the cycler controller module 

name: Deployment of battery cycler controller to real environment

on: workflow_call

env:
  ENV_CRED_TO_DEPLOY: ${{ secrets.ENV_CRED_TO_DEPLOY }}
        
jobs:
  launch-real-bat:
    name: Launch cycler controller in real environment
    runs-on: [self-hosted, linux, ARM64, plc]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Test to get var and secrets
        run: |
          echo "GITHUB_REPOSITORY: $GITHUB_REPOSITORY"
          echo "GITHUB_VAR: ${{ vars.CYCLER_STATION_ID }}"
          echo "$ENV_CRED_TO_DEPLOY"
      # - name: Set up Docker Buildx
      #   uses: docker/setup-buildx-action@v3
      # - name: Build and export
      #   uses: docker/build-push-action@v5
      #   with:
      #     context: .
      #     file: ./devops/docker/Dockerfile.cycler
      #     tags: wattrex-cycler:latest
      #     outputs: type=docker,dest=/tmp/wattrex-cycler-local.tar
      #     push: false
      # - name: Download zip devops and docker image artifacts
      #   uses: actions/download-artifact@v3
      #   with:
      #     path: /tmp
      # - name: Load docker image
      #   run: |
      #     docker load --input /tmp/wattrex-cycler-local.tar
      #     rm -f /tmp/wattrex-cycler-local.tar
      #     docker image ls -a
      #     ls -lAh /tmp
      # - name: Unzip devops
      #   run: |
      #     tar -xvf /tmp/wattrex-cycler-devops/wattrex-cycler-devops.tar -C /tmp
      #     rm -f /tmp/wattrex-cycler-devops/wattrex-cycler-devops.tar
      #     ls -lAh /tmp
      - name: Copy repository content
        run: |
          cp -r ./ /tmp/wattrex-cycler-staging
          ls -lAh /tmp/wattrex-cycler-staging
      - name: Set secrets to deploy
        run: |
          echo "${{ secrets.ENV_CRED_TO_DEPLOY }}" > /tmp/wattrex-cycler-staging/devops/.cred.env
          cat /tmp/wattrex-cycler-staging/devops/.cred.env
      - name: Build cycler docker image
        run: |
          docker build -t wattrex-cycler-node:latest --network=host -f /tmp/wattrex-cycler-staging/devops/docker/Dockerfile.cycler /tmp/wattrex-cycler-staging/
          docker image ls -a
      - name: Execute deploy script
        run: |
          chmod +x /tmp/wattrex-cycler-staging/devops/deploy.sh
          /tmp/wattrex-cycler-staging/devops/deploy.sh
      - name: Clean up
        run: |
          /tmp/wattrex-cycler-staging/devops/deploy.sh force-stop
          sudo rm -rf /tmp/wattrex-cycler-staging/
          docker image prune -f
          docker images -a
          ls -lAh /tmp